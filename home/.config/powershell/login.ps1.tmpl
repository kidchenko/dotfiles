# Chezmoi source directory (where dotfiles are managed)
$DOTFILES_DIR = if ($env:XDG_DATA_HOME) {
    Join-Path $env:XDG_DATA_HOME "chezmoi"
} else {
    Join-Path $HOME ".local/share/chezmoi"
}

$Hour = (Get-Date).Hour
$Name = "Jose"
$Theme = "robbyrussel.omp.json"

# Auto-update dotfiles (similar to Zsh .zlogin)
if (Test-Path "$DOTFILES_DIR/.git") {
    Push-Location $DOTFILES_DIR
    $fetch = git fetch --dry-run 2>&1
    if ($fetch) {
        Write-Host "[dotfiles] New version available."
        # Uncomment to enable auto-update on login
        # chezmoi update
    }
    Pop-Location
}

If ($Hour -lt 12) {"Good Morning $Name!"}

ElseIf ($Hour -gt 16) {"Good Evening $Name!"}

Else {"Good Afternoon $Name!"; }

# Allow remote execution
if (!($IsMacOS)) {
    Set-ExecutionPolicy Bypass -Scope CurrentUser -Force -ErrorAction SilentlyContinue;
}

# use tls 1.2
[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072;

oh-my-posh init pwsh --config "$env:POSH_THEMES_PATH/$Theme" | Invoke-Expression

# enable AWS command completion
# https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-completion.html
Register-ArgumentCompleter -Native -CommandName aws -ScriptBlock {
    param($commandName, $wordToComplete, $cursorPosition)
        $env:COMP_LINE=$wordToComplete
        if ($env:COMP_LINE.Length -lt $cursorPosition){
            $env:COMP_LINE=$env:COMP_LINE + " "
        }
        $env:COMP_POINT=$cursorPosition
        aws_completer.exe | ForEach-Object {
            [System.Management.Automation.CompletionResult]::new($_, $_, 'ParameterValue', $_)
        }
        Remove-Item Env:\COMP_LINE
        Remove-Item Env:\COMP_POINT
}
