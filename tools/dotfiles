#!/bin/bash
#
# dotfiles - CLI for managing dotfiles
#
# Usage:
#   dotfiles <command> [options]
#
# Commands:
#   doctor      Run health checks
#   bootstrap   Bootstrap dotfiles on new machine
#   destroy     Remove dotfiles and state
#   update      Pull and apply latest changes
#   apply       Apply dotfiles (chezmoi apply)
#   diff        Show pending changes (chezmoi diff)
#   edit        Edit dotfiles source (chezmoi edit)
#   cd          Print path to dotfiles source
#   backup      Backup project folders
#   cron        Manage scheduled tasks
#   install     Install packages (brew bundle)
#   cleanup     Remove packages not in Brewfile
#   logs        View cron job logs
#   extensions  Install VS Code extensions
#   defaults    Apply macOS system defaults
#   ssh         Setup SSH keys with 1Password
#   help        Show this help message
#

DOTFILES_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/chezmoi"
TOOLS_DIR="$DOTFILES_DIR/tools"
SCRIPTS_DIR="$DOTFILES_DIR/scripts"

# Colors
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    BOLD='\033[1m'
    NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BOLD='' NC=''
fi

say() { echo -e "${GREEN}[dotfiles]${NC} $1"; }
error() { echo -e "${RED}[dotfiles] ERROR:${NC} $1" >&2; exit 1; }

show_help() {
    echo -e "${BOLD}dotfiles${NC} - CLI for managing dotfiles"
    echo ""
    echo -e "${BOLD}Usage:${NC}"
    echo "  dotfiles <command> [options]"
    echo ""
    echo -e "${BOLD}Commands:${NC}"
    echo "  doctor [--quick|--fix]   Run health checks"
    echo "  bootstrap                Bootstrap dotfiles on new machine"
    echo "  destroy [--all|--deep]   Remove dotfiles and state"
    echo "  update                   Pull and apply latest changes"
    echo "  apply                    Apply dotfiles (chezmoi apply)"
    echo "  diff                     Show pending changes"
    echo "  edit [file]              Edit dotfiles source"
    echo "  cd                       Print path to dotfiles source"
    echo "  status                   Show git status of dotfiles"
    echo "  backup [cmd]             Backup project folders"
    echo "  cron [list|setup]        Manage scheduled tasks"
    echo "  install                  Install packages (brew bundle)"
    echo "  cleanup                  Remove packages not in Brewfile"
    echo "  logs [backup|brew]       View cron job logs"
    echo "  extensions               Install VS Code extensions"
    echo "  defaults                 Apply macOS system defaults"
    echo "  ssh                      Setup SSH keys with 1Password"
    echo "  help                     Show this help message"
    echo ""
    echo -e "${BOLD}Examples:${NC}"
    echo "  dotfiles doctor          # Run all health checks"
    echo "  dotfiles doctor --quick  # Skip slow checks"
    echo "  dotfiles doctor --fix    # Auto-fix issues"
    echo "  dotfiles apply           # Apply pending changes"
    echo "  dotfiles edit            # Open dotfiles in editor"
    echo "  cd \$(dotfiles cd)        # Navigate to dotfiles"
    echo ""
    echo -e "${BOLD}Backup commands:${NC}"
    echo "  dotfiles backup          # Create a backup"
    echo "  dotfiles backup list     # List available backups"
    echo "  dotfiles backup restore  # Restore from backup"
    echo ""
    echo -e "${BOLD}Cron commands:${NC}"
    echo "  dotfiles cron            # List scheduled tasks"
    echo "  dotfiles cron setup      # Setup all cron jobs"
    echo ""
}

cmd_doctor() {
    if [[ -f "$TOOLS_DIR/doctor.sh" ]]; then
        bash "$TOOLS_DIR/doctor.sh" "$@"
    else
        error "doctor.sh not found in $TOOLS_DIR"
    fi
}

cmd_bootstrap() {
    if [[ -f "$TOOLS_DIR/bootstrap.sh" ]]; then
        bash "$TOOLS_DIR/bootstrap.sh" "$@"
    else
        error "bootstrap.sh not found in $TOOLS_DIR"
    fi
}

cmd_destroy() {
    if [[ -f "$TOOLS_DIR/destroy.sh" ]]; then
        bash "$TOOLS_DIR/destroy.sh" "$@"
    else
        error "destroy.sh not found in $TOOLS_DIR"
    fi
}

cmd_update() {
    if [[ -f "$TOOLS_DIR/update.sh" ]]; then
        bash "$TOOLS_DIR/update.sh" "$@"
    else
        # Fallback to chezmoi update
        say "Updating dotfiles..."
        chezmoi update
    fi
}

cmd_apply() {
    say "Applying dotfiles..."
    chezmoi apply "$@"
    say "Done!"
}

cmd_diff() {
    chezmoi diff "$@"
}

cmd_edit() {
    if [[ -n "$1" ]]; then
        chezmoi edit "$@"
    else
        # Open dotfiles directory in editor
        ${EDITOR:-code} "$DOTFILES_DIR"
    fi
}

cmd_cd() {
    echo "$DOTFILES_DIR"
}

cmd_status() {
    git -C "$DOTFILES_DIR" status "$@"
}

cmd_backup() {
    local backup_script="$SCRIPTS_DIR/backup/backup-projects.sh"
    if [[ -f "$backup_script" ]]; then
        bash "$backup_script" "$@"
    else
        error "backup-projects.sh not found in $SCRIPTS_DIR/backup"
    fi
}

cmd_install() {
    local BREWFILE="$DOTFILES_DIR/Brewfile"

    if [[ ! -f "$BREWFILE" ]]; then
        error "Brewfile not found at $BREWFILE"
    fi

    say "Installing packages from Brewfile..."
    brew bundle install --file="$BREWFILE" "$@"
    say "Done!"
}

cmd_cleanup() {
    local BREWFILE="$DOTFILES_DIR/Brewfile"

    if [[ ! -f "$BREWFILE" ]]; then
        error "Brewfile not found at $BREWFILE"
    fi

    say "Checking for packages not in Brewfile..."
    brew bundle cleanup --file="$BREWFILE" "$@"
}

cmd_logs() {
    local LOG_DIR="${HOME}/.local/log"

    case "${1:-list}" in
        backup)
            if [[ -f "$LOG_DIR/backup.log" ]]; then
                less +G "$LOG_DIR/backup.log"
            elif [[ -f "$LOG_DIR/backup-cron.log" ]]; then
                less +G "$LOG_DIR/backup-cron.log"
            else
                echo "No backup logs found in $LOG_DIR"
            fi
            ;;
        brew|bundle)
            if [[ -f "$LOG_DIR/brew-bundle.log" ]]; then
                less +G "$LOG_DIR/brew-bundle.log"
            else
                echo "No brew bundle logs found in $LOG_DIR"
            fi
            ;;
        list|*)
            echo -e "${BOLD}Available Logs${NC}"
            echo ""
            if [[ -d "$LOG_DIR" ]]; then
                for log in "$LOG_DIR"/*.log; do
                    [[ -f "$log" ]] || continue
                    local name
                    local size
                    local modified
                    name=$(basename "$log" .log)
                    size=$(du -h "$log" | cut -f1)
                    modified=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M" "$log" 2>/dev/null)
                    echo -e "  ${GREEN}$name${NC} ($size) - $modified"
                done
                echo ""
                echo "View a log: dotfiles logs <name>"
            else
                echo "  No logs directory found"
            fi
            ;;
    esac
}

cmd_cron() {
    local CRON_DIR="$DOTFILES_DIR/cron"

    case "${1:-list}" in
        list)
            echo -e "${BOLD}Scheduled Tasks${NC}"
            echo ""
            # Match both chezmoi path and git repo path for cron scripts
            if crontab -l 2>/dev/null | grep -qE "cron/(update|backup)\.sh"; then
                crontab -l 2>/dev/null | grep -E "cron/(update|backup)\.sh" | while read -r line; do
                    local schedule
                    local script
                    local desc=""
                    schedule=$(echo "$line" | awk '{print $1, $2, $3, $4, $5}')
                    script=$(echo "$line" | awk '{print $6}' | xargs basename)
                    case "$script" in
                        update.sh) desc="Weekly brew bundle" ;;
                        backup.sh) desc="Weekly backup" ;;
                        *) desc="$script" ;;
                    esac
                    # Parse cron schedule to human readable
                    case "$schedule" in
                        "0 9 * * 1") echo -e "  ${GREEN}✓${NC} $desc (Monday 9am)" ;;
                        "0 2 * * 0") echo -e "  ${GREEN}✓${NC} $desc (Sunday 2am)" ;;
                        *) echo -e "  ${GREEN}✓${NC} $desc ($schedule)" ;;
                    esac
                done
            else
                echo -e "  ${YELLOW}No dotfiles cron jobs configured${NC}"
                echo ""
                echo "  Run: dotfiles cron setup"
            fi
            echo ""
            ;;
        setup)
            if [[ -f "$CRON_DIR/setup-cron.sh" ]]; then
                bash "$CRON_DIR/setup-cron.sh"
            else
                error "setup-cron.sh not found in $CRON_DIR"
            fi
            ;;
        *)
            echo "Usage: dotfiles cron [list|setup]"
            echo ""
            echo "Commands:"
            echo "  list   Show configured cron jobs (default)"
            echo "  setup  Install/update all cron jobs"
            ;;
    esac
}

cmd_extensions() {
    local extensions_script="$TOOLS_DIR/install-vscode-extensions.sh"

    if [[ -f "$extensions_script" ]]; then
        bash "$extensions_script" "$@"
    else
        error "install-vscode-extensions.sh not found in $TOOLS_DIR"
    fi
}

cmd_defaults() {
    local defaults_script="$TOOLS_DIR/os_setup/macos-config.sh"

    if [[ ! "$(uname -s)" == "Darwin" ]]; then
        error "This command is only available on macOS"
    fi

    if [[ -f "$defaults_script" ]]; then
        say "Applying macOS defaults..."
        bash "$defaults_script" "$@"
    else
        error "macos-config.sh not found in $TOOLS_DIR/os_setup"
    fi
}

cmd_ssh() {
    local ssh_script="$TOOLS_DIR/setup-ssh-keys.sh"

    if [[ -f "$ssh_script" ]]; then
        bash "$ssh_script" "$@"
    else
        error "setup-ssh-keys.sh not found in $TOOLS_DIR"
    fi
}

# Main
case "${1:-help}" in
    doctor)
        shift
        cmd_doctor "$@"
        ;;
    bootstrap)
        shift
        cmd_bootstrap "$@"
        ;;
    destroy)
        shift
        cmd_destroy "$@"
        ;;
    update)
        shift
        cmd_update "$@"
        ;;
    apply)
        shift
        cmd_apply "$@"
        ;;
    diff)
        shift
        cmd_diff "$@"
        ;;
    edit)
        shift
        cmd_edit "$@"
        ;;
    cd)
        cmd_cd
        ;;
    status)
        shift
        cmd_status "$@"
        ;;
    backup)
        shift
        cmd_backup "$@"
        ;;
    cron)
        shift
        cmd_cron "$@"
        ;;
    install)
        shift
        cmd_install "$@"
        ;;
    cleanup)
        shift
        cmd_cleanup "$@"
        ;;
    logs)
        shift
        cmd_logs "$@"
        ;;
    extensions)
        shift
        cmd_extensions "$@"
        ;;
    defaults)
        shift
        cmd_defaults "$@"
        ;;
    ssh)
        shift
        cmd_ssh "$@"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        error "Unknown command: $1\nRun 'dotfiles help' for usage."
        ;;
esac
