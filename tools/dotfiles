#!/bin/bash
#
# dotfiles - CLI for managing dotfiles
#
# Usage:
#   dotfiles <command> [options]
#
# Commands:
#   doctor      Run health checks
#   bootstrap   Bootstrap dotfiles on new machine
#   destroy     Remove dotfiles and state
#   update      Pull and apply latest changes
#   apply       Apply dotfiles (chezmoi apply)
#   diff        Show pending changes (chezmoi diff)
#   edit        Edit dotfiles source (chezmoi edit)
#   cd          Print path to dotfiles source
#   backup      Backup project folders
#   cron        Manage scheduled tasks
#   install     Install packages (brew bundle)
#   help        Show this help message
#

DOTFILES_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/chezmoi"
TOOLS_DIR="$DOTFILES_DIR/tools"
SCRIPTS_DIR="$DOTFILES_DIR/scripts"

# Colors
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    BOLD='\033[1m'
    NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BOLD='' NC=''
fi

say() { echo -e "${GREEN}[dotfiles]${NC} $1"; }
error() { echo -e "${RED}[dotfiles] ERROR:${NC} $1" >&2; exit 1; }

show_help() {
    echo -e "${BOLD}dotfiles${NC} - CLI for managing dotfiles"
    echo ""
    echo -e "${BOLD}Usage:${NC}"
    echo "  dotfiles <command> [options]"
    echo ""
    echo -e "${BOLD}Commands:${NC}"
    echo "  doctor [--quick|--fix]   Run health checks"
    echo "  bootstrap                Bootstrap dotfiles on new machine"
    echo "  destroy [--all|--deep]   Remove dotfiles and state"
    echo "  update                   Pull and apply latest changes"
    echo "  apply                    Apply dotfiles (chezmoi apply)"
    echo "  diff                     Show pending changes"
    echo "  edit [file]              Edit dotfiles source"
    echo "  cd                       Print path to dotfiles source"
    echo "  status                   Show git status of dotfiles"
    echo "  backup [cmd]             Backup project folders"
    echo "  cron [list|setup]        Manage scheduled tasks"
    echo "  install                  Install packages (brew bundle)"
    echo "  help                     Show this help message"
    echo ""
    echo -e "${BOLD}Examples:${NC}"
    echo "  dotfiles doctor          # Run all health checks"
    echo "  dotfiles doctor --quick  # Skip slow checks"
    echo "  dotfiles doctor --fix    # Auto-fix issues"
    echo "  dotfiles apply           # Apply pending changes"
    echo "  dotfiles edit            # Open dotfiles in editor"
    echo "  cd \$(dotfiles cd)        # Navigate to dotfiles"
    echo ""
    echo -e "${BOLD}Backup commands:${NC}"
    echo "  dotfiles backup          # Create a backup"
    echo "  dotfiles backup list     # List available backups"
    echo "  dotfiles backup restore  # Restore from backup"
    echo ""
    echo -e "${BOLD}Cron commands:${NC}"
    echo "  dotfiles cron            # List scheduled tasks"
    echo "  dotfiles cron setup      # Setup all cron jobs"
    echo ""
}

cmd_doctor() {
    if [[ -f "$TOOLS_DIR/doctor.sh" ]]; then
        bash "$TOOLS_DIR/doctor.sh" "$@"
    else
        error "doctor.sh not found in $TOOLS_DIR"
    fi
}

cmd_bootstrap() {
    if [[ -f "$TOOLS_DIR/bootstrap.sh" ]]; then
        bash "$TOOLS_DIR/bootstrap.sh" "$@"
    else
        error "bootstrap.sh not found in $TOOLS_DIR"
    fi
}

cmd_destroy() {
    if [[ -f "$TOOLS_DIR/destroy.sh" ]]; then
        bash "$TOOLS_DIR/destroy.sh" "$@"
    else
        error "destroy.sh not found in $TOOLS_DIR"
    fi
}

cmd_update() {
    if [[ -f "$TOOLS_DIR/update.sh" ]]; then
        bash "$TOOLS_DIR/update.sh" "$@"
    else
        # Fallback to chezmoi update
        say "Updating dotfiles..."
        chezmoi update
    fi
}

cmd_apply() {
    say "Applying dotfiles..."
    chezmoi apply "$@"
    say "Done!"
}

cmd_diff() {
    chezmoi diff "$@"
}

cmd_edit() {
    if [[ -n "$1" ]]; then
        chezmoi edit "$@"
    else
        # Open dotfiles directory in editor
        ${EDITOR:-code} "$DOTFILES_DIR"
    fi
}

cmd_cd() {
    echo "$DOTFILES_DIR"
}

cmd_status() {
    git -C "$DOTFILES_DIR" status "$@"
}

cmd_backup() {
    local backup_script="$SCRIPTS_DIR/backup/backup-projects.sh"
    if [[ -f "$backup_script" ]]; then
        bash "$backup_script" "$@"
    else
        error "backup-projects.sh not found in $SCRIPTS_DIR/backup"
    fi
}

cmd_install() {
    local BREWFILE="$DOTFILES_DIR/Brewfile"

    if [[ ! -f "$BREWFILE" ]]; then
        error "Brewfile not found at $BREWFILE"
    fi

    say "Installing packages from Brewfile..."
    brew bundle install --file="$BREWFILE" "$@"
    say "Done!"
}

cmd_cron() {
    local CRON_DIR="$DOTFILES_DIR/cron"

    case "${1:-list}" in
        list)
            echo -e "${BOLD}Scheduled Tasks${NC}"
            echo ""
            # Match both chezmoi path and git repo path for cron scripts
            if crontab -l 2>/dev/null | grep -qE "cron/(update|backup)\.sh"; then
                crontab -l 2>/dev/null | grep -E "cron/(update|backup)\.sh" | while read -r line; do
                    local schedule=$(echo "$line" | awk '{print $1, $2, $3, $4, $5}')
                    local script=$(echo "$line" | awk '{print $6}' | xargs basename)
                    local desc=""
                    case "$script" in
                        update.sh) desc="Weekly brew bundle" ;;
                        backup.sh) desc="Weekly backup" ;;
                        *) desc="$script" ;;
                    esac
                    # Parse cron schedule to human readable
                    case "$schedule" in
                        "0 9 * * 1") echo -e "  ${GREEN}✓${NC} $desc (Monday 9am)" ;;
                        "0 2 * * 0") echo -e "  ${GREEN}✓${NC} $desc (Sunday 2am)" ;;
                        *) echo -e "  ${GREEN}✓${NC} $desc ($schedule)" ;;
                    esac
                done
            else
                echo -e "  ${YELLOW}No dotfiles cron jobs configured${NC}"
                echo ""
                echo "  Run: dotfiles cron setup"
            fi
            echo ""
            ;;
        setup)
            if [[ -f "$CRON_DIR/setup-cron.sh" ]]; then
                bash "$CRON_DIR/setup-cron.sh"
            else
                error "setup-cron.sh not found in $CRON_DIR"
            fi
            ;;
        *)
            echo "Usage: dotfiles cron [list|setup]"
            echo ""
            echo "Commands:"
            echo "  list   Show configured cron jobs (default)"
            echo "  setup  Install/update all cron jobs"
            ;;
    esac
}

# Main
case "${1:-help}" in
    doctor)
        shift
        cmd_doctor "$@"
        ;;
    bootstrap)
        shift
        cmd_bootstrap "$@"
        ;;
    destroy)
        shift
        cmd_destroy "$@"
        ;;
    update)
        shift
        cmd_update "$@"
        ;;
    apply)
        shift
        cmd_apply "$@"
        ;;
    diff)
        shift
        cmd_diff "$@"
        ;;
    edit)
        shift
        cmd_edit "$@"
        ;;
    cd)
        cmd_cd
        ;;
    status)
        shift
        cmd_status "$@"
        ;;
    backup)
        shift
        cmd_backup "$@"
        ;;
    cron)
        shift
        cmd_cron "$@"
        ;;
    install)
        shift
        cmd_install "$@"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        error "Unknown command: $1\nRun 'dotfiles help' for usage."
        ;;
esac
